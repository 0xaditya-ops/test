name: Nginx Deployment

on:
  workflow_dispatch:
    inputs:
      target_machine:
        description: 'Target machine to deploy to'
        required: true
        type: choice
        options:
          - 51.77.18.149
          - 51.68.100.192
          - All of the above
      nginx_version:
        description: 'Nginx version to deploy (e.g., 1.25.3)'
        required: true
        type: string
      ssh_user:
        description: 'SSH user for target machines'
        required: true
        type: choice
        options:
          - ubuntu
          - ec2-user
        default: ubuntu

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      ALL_MACHINES: |
        51.77.18.149
        51.68.100.192
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Determine target machines
        id: determine_targets
        run: |
          if [ "${{ inputs.target_machine }}" == "All of the above" ]; then
            echo "machines<<EOF" >> $GITHUB_OUTPUT
            echo "${{ env.ALL_MACHINES }}" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "machines<<EOF" >> $GITHUB_OUTPUT
            echo "${{ inputs.target_machine }}" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Add target machines to known hosts
        run: |
          while IFS= read -r machine; do
            if [ -n "$machine" ]; then
              ssh-keyscan -H "$machine" >> ~/.ssh/known_hosts || true
            fi
          done <<< "${{ steps.determine_targets.outputs.machines }}"

      - name: Deploy nginx to machines
        run: |
          set +e  # Don't exit on error, we handle errors in the loop
          
          ssh_user="${{ inputs.ssh_user }}"
          home_dir="/home/$ssh_user"
          
          machines_list="${{ steps.determine_targets.outputs.machines }}"
          echo "Target machines to deploy:"
          echo "$machines_list"
          echo "Using SSH user: $ssh_user"
          echo "Home directory: $home_dir"
          echo "---"
          
          # Convert multiline string to array, filtering out empty lines
          mapfile -t machines < <(echo "$machines_list" | grep -v '^[[:space:]]*$' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
          
          echo "DEBUG: Found ${#machines[@]} machine(s) to deploy"
          
          for machine in "${machines[@]}"; do
            if [ -z "$machine" ]; then
              echo "DEBUG: Skipping empty machine"
              continue
            fi
            
            echo "========================================="
            echo "Deploying nginx ${{ inputs.nginx_version }} to: $machine (user: $ssh_user)"
            echo "========================================="

            # Create nginx-deployment directory if it doesn't exist
            # Use absolute path to avoid ~ expansion issues
            ssh "$ssh_user@$machine" "mkdir -p $home_dir/bins/nginx-deployment" || {
              echo "Failed to create nginx-deployment directory on $machine"
              continue
            }
            
            # Copy deploy script to fixed location (always override existing)
            # Use absolute path to avoid ~ expansion issues with scp
            scp scripts/binary-deployment/deploy-nginx.sh "$ssh_user@$machine:$home_dir/bins/nginx-deployment/deploy-nginx.sh" || {
              echo "Failed to copy deploy script to $machine"
              continue
            }
            
            # Make script executable
            ssh "$ssh_user@$machine" "chmod +x $home_dir/bins/nginx-deployment/deploy-nginx.sh" || {
              echo "Failed to make deploy script executable on $machine"
              continue
            }
            
            # Create/override env_vars file with nginx version
            ssh "$ssh_user@$machine" "printf 'NGINX_VERSION=%s\n' '${{ inputs.nginx_version }}' > $home_dir/bins/nginx-deployment/env_vars" || {
              echo "Failed to create env_vars on $machine"
              continue
            }

            # Execute deployment script from fixed location
            ssh "$ssh_user@$machine" "bash $home_dir/bins/nginx-deployment/deploy-nginx.sh" || {
              echo "Deployment failed on $machine"
              continue
            }
            
            echo "Successfully deployed nginx ${{ inputs.nginx_version }} to $machine"
            echo ""
          done
          
          echo "========================================="
          echo "Deployment process completed for all machines"
          echo "========================================="
